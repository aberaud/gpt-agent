<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI output viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <style>
body {
    position: absolute;
    width: 100%;
    height: 100%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.content {
  flex: 1;
  padding: 1rem;
  overflow-y: hidden;
  display: flex;
  overflow-x: auto; /* Enable horizontal scrolling for the cards container */
  white-space: nowrap; /* Prevent cards from wrapping to the next line */
}
.agent-container {
    width: calc(576px - 3rem);
    min-width: calc(576px - 3rem);
    margin-left: .5rem;
    margin-right: .5rem;
}
@media (max-width: 576px) {
    .agent-container {
        width: calc(100% - 1rem);
        min-width: calc(100% - 1rem);
    }
}
.agent {
    max-height: 100%;
    white-space: normal;
    display: flex;
    flex-direction: column;
}
.messages {
    flex: 1;
    overflow-y: auto;
}
    </style>    
    <script>
const getClass = role => {
    switch (role) {
        case 'user': return 'list-group-item-primary'
        case 'assistant': return 'list-group-item-success'
        case 'system': return 'list-group-item-warning'
        default: return ''
    }
}
const default_command = {
    icon: msg => 'bi-chat-left-dots-fill',
    message: msg => `<b>${msg.command} ${msg.args.join(' ')}</b><pre>${escapeHtml(msg.content)}</pre>`
}
const commands = {
    COMPLETE: {
        icon: msg => msg.args[0] == 'success' ? 'bi-check-circle-fill' : 'bi-x-circle-fill text-danger',
        message: msg => msg.content
    },
    INFO: {
        icon: msg => 'bi-info-circle-fill',
        message: msg => msg.content
    },
    WRITE: {
        icon: msg => 'bi-pencil-fill',
        message: msg => `<b>${msg.args[0]}</b><pre>${escapeHtml(msg.content)}</pre>`
    },
    RUN: {
        icon: msg => 'bi-terminal-fill',
        message: msg => `<b>Bash></b><pre><code class="language-bash">${hljs.highlight(msg.content, {language: 'bash'}).value}</code></pre>`
    },
    PYTHON: {
        icon: msg => 'bi-terminal-fill',
        message: msg => `<b>Python></b><pre><code class="language-python">${hljs.highlight(msg.content, {language: 'python'}).value}</code></pre>`
    },
    ASSIGN: {
        icon: msg => 'bi-diagram-3-fill',
        message: msg => `<b>${msg.args[0]}</b> ${escapeHtmlFull(msg.content)}`
    },
    REQUEST: {
        icon: msg => 'bi-question-circle-fill',
        message: msg => `Request for ${msg.args[0]}<br/><b>${escapeHtmlFull(msg.content)}</b>`
    },
    INSTRUCTIONS: {
        icon: msg => 'bi-journal-check',
        message: msg => `<pre>${escapeHtml(msg.content)}</pre>`
    },
    IDENTITY: {
        icon: msg => 'bi-journal-check',
        message: msg => `<b>${escapeHtmlFull(msg.content)}</b>`
    },
    USER_INPUT: {
        icon: msg => 'bi-journal-check',
        message: msg => `<b>${escapeHtmlFull(msg.content)}</b>`
    },
    ENVIRONMENT: {
        icon: msg => 'bi-info-circle',
        message: msg => `<pre>${escapeHtml(msg.content)}</pre>`
    },
    OUTPUT: {
        icon: msg => 'bi-info-circle',
        message: msg => `<pre>${escapeHtml(msg.content)}</pre>`
    },
    PARSE_ERROR: {
        icon: msg => 'bi-exclamation-circle-fill',
        message: msg => `<b>Parsing error</b><pre>${escapeHtml(msg.content)}</pre>`
    },
}
const escapeHtml = unsafe => unsafe ? unsafe.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;') : ''
const escapeHtmlFull = unsafe => unsafe ? escapeHtml(unsafe).replaceAll('\n', '<br/>') : ''

/*const getIcon = message => {
    switch (message.command) {
        case 'info': return 'bi-info-circle-fill'
        case 'completed': return message.content == 'success' ? 'bi-check-circle' : 'bi-x-circle text-danger'
        case 'COMPLETE': return message.content == 'success' ? 'bi-check-circle-fill' : 'bi-x-circle-fill text-danger'
        case 'request': return 'bi-question-circle-fill'
        case 'command': return 'bi-terminal-fill'
        case 'WRITE': return 'bi-pencil-fill'
        case 'ASSIGN': return 'bi-diagram-3-fill'
        case 'parse_error':
        case 'error': return 'bi-exclamation-circle-fill'
        case 'INSTRUCTIONS':
        case 'IDENTITY':
        case 'USER_INPUT': return 'bi-journal-check'
        case 'query': return 'bi-search'
        case 'file': return message.content ? 'bi-check-circle-fill' : 'bi-x-circle-fill text-danger'
        default: return 'bi-chat-left-dots-fill'
    }
}
const getMessage = message => {
    switch (message.command) {
        case 'info':
        case 'completed':
        case 'COMPLETE':
        case 'request': return message.content
        case 'command': return Array.isArray(message.command) ? message.command.map(c => `<pre><code class="language-bash">${c}<code></pre>`).join('\n')  : `<pre>${message.command || ''}</pre>`
        case 'WRITE': return `<b>${message.args[0]}</b><pre>${message.content}</pre>`
        case 'reply':
        case 'IDENTITY':
        case 'USER_INPUT': return `<b>${message.content}</b>`
        case 'task': return `<b>${message.args[0]}</b> ${message.content}`
        case 'ASSIGN': return `<b>${message.args[0]}</b> ${message.content}`
        case 'QUERY': return `<b>${message.args[0]}</b> ${message.content}`
        case 'file': return message.success ? `<b>${message.file}</b>` : `<b>${message.file}</b> ${message.error}`
        case 'INSTRUCTIONS':
        case 'parse_error':
        case 'error': return `<pre>${escapeHtml(message.content)}</pre>`
        default: return `<pre>${escapeHtml(message.content)}</pre>`
    }
}*/

const messageRow = message => {
    const display = {...default_command, ...(commands[message.command.command] || {})}
    console.log(message, display)
    return `<li class="list-group-item message ${getClass(message.role)}">
        <i class="${display.icon(message.command)} flex-shrink-0 me-2"></i>
        ${display.message(message.command)}
    </li>`
}

const agentCard = agent => 
    `<div class="card agent${agent.completed ? ' text-bg-secondary' : ''}" id="agent-${agent.id}">
        <div class="card-header"><h5 class="card-title">${agent.id}</h5></div>
        <ul class="messages list-group list-group-flush">
            ${agent.messages.reverse().map(message => messageRow(message)).join('\n')}
        </ul>
    </div>`

const addResult = (container, agent) => {
    const card = document.createElement('div')
    card.id = `agent-${agent.id}-container`
    card.classList.add('agent-container')
    if (agent.completed)
        card.classList.add('agent-complete')
    card.innerHTML = agentCard(agent)
    container.insertBefore(card, container.firstChild)
    card.animate([{ opacity: 0, transform: 'scale(.8)', width: '80px' }, {}],
        { duration: 400, easing: 'ease-out' })
    return card
}
const updateCard = (card, agent) => {
    console.log('updateCard', agent)
    card.innerHTML = agentCard(agent)
    if (agent.completed)
        card.classList.add('agent-complete')
}
const onSubmit = (e, id) => {
    console.log(e)
    ws.send(JSON.stringify({ id: id, message: e.target.querySelector('input').value }))
    e.target.remove()
    return false
}
const inputBox = (id, msg) => `<form onsubmit="return onSubmit(event, '${id}')">
                <label class="form-label">${msg}</label>
                <input type="text" class="form-control">
            </form>`

const new_websocket = (dispatch) => {
    const container = document.getElementById('main-content')
    const loader = document.getElementById('loader')
    const textMsg = document.getElementById('main-title')
    const ws = new WebSocket(`ws://${window.location.hostname}:${window.location.port}/ws`)
    ws.binaryType = "blob"
    ws.onopen = () => {
        textMsg.textContent = 'Connected'
        loader.remove()
    }
    ws.onclose = () => textMsg.textContent = 'Disconnected'
    ws.onerror = (e) => console.log(e)
    ws.onmessage = (m) => {
        try {
            if (typeof m.data == "string") {
                const data = JSON.parse(m.data)
                console.log(data)
                if (data.agents) {
                    for (const agent of data.agents) {
                        console.log(agent)
                        agent.completed = agent.messages[agent.messages.length - 1].command.command == 'COMPLETE'
                        const card = document.getElementById(`agent-${agent.id}-container`)
                        if (card)
                            updateCard(card, agent)
                        else
                            container.prepend(addResult(container, agent))
                    }
                    Array.from(container.getElementsByClassName('agent-complete')).reverse().forEach(agent => {
                        container.removeChild(agent)
                        container.appendChild(agent)
                    })
                }
                if (data.state == 'request') {
                    let card = document.getElementById(`agent-${data.id}`)
                    if (!card) {
                        card = addResult(container, { id: data.id, messages: [] })
                        container.prepend(card)
                    }
                    textMsg.textContent = `Waiting for human input: ${data.id}`
                    const header = card.querySelector('.card-header')
                    header.innerHTML = `<h5 class="card-title">${data.id}</h5>${inputBox(data.id, data.message)}`
                        /*<div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>`*/
                } else if (data.state == 'running') {
                    //data.agents[data.agents.length - 1].messages.push(data.message)
                    loader.remove()
                    const lastAgent = data.agents[data.agents.length - 1]
                    textMsg.textContent = `Agent running: ${lastAgent.id}`
                    const card = document.getElementById(`agent-${lastAgent.id}`)
                    if (card) {
                        const header = card.querySelector('.card-header')
                        header.appendChild(loader)
                    }
                } else if (data.state == 'completed') {
                    textMsg.textContent = 'Completed'
                    loader.remove()
                }
            }
        } catch (e) {
            console.log(`Failed to handle websocket message:`)
            console.log(e)
        }
    }
    return ws
}
    </script>
</head>
<body class="bg-dark-subtle">
    <header>
        <div id="searchbar" class="container">
            <h1 id="main-title" class="display-5">Connecting...</h1>
            <div id="loader" class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            
        </div>
    </header>
    <div class="content" id="main-content"></div>
    <script>
const ws = new_websocket()
    </script>
</body>
</html>
