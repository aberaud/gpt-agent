<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI output viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js" integrity="sha512-CSBhVREyzHAjAFfBlIBakjoRUKp5h7VSweP0InR/pAJyptH7peuhCsqAI/snV+TwZmXZqoUklpXp6R6wMnYf5Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
body {
    position: absolute;
    width: 100%;
    height: 100%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.content {
  flex: 1;
  padding: 1rem;
  overflow-y: hidden;
  display: flex;
  overflow-x: auto; /* Enable horizontal scrolling for the cards container */
  white-space: nowrap; /* Prevent cards from wrapping to the next line */
}
.agent-container {
    width: calc(576px - 3rem);
    min-width: calc(576px - 3rem);
    margin-left: .5rem;
    margin-right: .5rem;
}
@media (max-width: 576px) {
    .agent-container {
        width: calc(100% - 1rem);
        min-width: calc(100% - 1rem);
    }
}
.agent {
    max-height: 100%;
    white-space: normal;
    display: flex;
    flex-direction: column;
}
.messages {
    flex: 1;
    overflow-y: auto;
}
    </style>    
    <script>
const getClass = role => {
    switch (role) {
        case 'user': return 'list-group-item-primary'
        case 'assistant': return 'list-group-item-success'
        case 'system': return 'list-group-item-warning'
        default: return ''
    }
}
const getIcon = content => {
    switch (content.type) {
        case 'info': return 'bi-info-circle-fill'
        case 'completed': return content.status == 'success' ? 'bi-check-circle' : 'bi-x-circle text-danger'
        case 'complete': return content.status == 'success' ? 'bi-check-circle-fill' : 'bi-x-circle-fill text-danger'
        case 'request': return 'bi-question-circle-fill'
        case 'command': return 'bi-terminal-fill'
        case 'write': return 'bi-pencil-fill'
        case 'assign': return 'bi-diagram-3-fill'
        case 'parse_error':
        case 'error': return 'bi-exclamation-circle-fill'
        case 'task':
        case 'main_task': return 'bi-journal-check'
        case 'query': return 'bi-search'
        case 'file': return content.success ? 'bi-check-circle-fill' : 'bi-x-circle-fill text-danger'
        default: return 'bi-chat-left-dots-fill'
    }
}
const getMessage = content => {
    switch (content.type) {
        case 'info':
        case 'completed':
        case 'complete':
        case 'parse_error':
        case 'error':
        case 'request': return content.message
        case 'command': return Array.isArray(content.command) ? content.command.map(c => `<pre>${c}</pre>`).join('\n')  : `<pre>${content.command || ''}</pre>`
        case 'write': return `<b>${content.file}</b><pre>${content.content}</pre>`
        case 'reply':
        case 'main_task': return `<b>${content.task}</b>`
        case 'task': return `<b>${content.instructions}</b> ${content.task}`
        case 'assign': return `<b>${content.id}</b> ${content.task}`
        case 'query': return `<b>${content.source}</b> ${content.query}`
        case 'file': return content.success ? `<b>${content.file}</b>` : `<b>${content.file}</b> ${content.error}`
        default: return `<pre>${jsyaml.dump(content)}</pre>`
    }
}

const parseMessage = message => {
    try {
        const msg = jsyaml.load(message)
        if (!msg.type) {
            if ('stdout' in msg || 'stderr' in msg) {
                msg.type = 'command'
                msg.command = msg.stdout || msg.stderr
            } else if (msg.instructions && !msg.purpose) {
                msg.type = 'task'
            } else if (msg.file) {
                msg.type = 'file'
            }
        }
        console.log(msg)
        return msg
    } catch (e) {
        return { type: 'parse_error', message: message }
    }
}

const messageRow = (message, content) =>
    `<li class="list-group-item message ${getClass(message.role)}">
        <i class="${getIcon(content)} flex-shrink-0 me-2"></i>
        ${getMessage(content)}
    </li>`

const agentCard = agent =>
    `<div class="card agent" id="agent-${agent.id}">
        <div class="card-header"><h5 class="card-title">${agent.id}</h5></div>
        <ul class="messages list-group list-group-flush">
            ${agent.messages.reverse().map(message => messageRow(message, parseMessage(message.content))).join('\n')}
        </ul>
    </div>`
const addResult = (container, agent) => {
    const card = document.createElement('div')
    card.classList.add('agent-container')
    card.innerHTML = agentCard(agent)
    container.insertBefore(card, container.firstChild)
    card.animate([{ opacity: 0, transform: 'scale(.8)', width: '80px' }, {}],
        { duration: 400, easing: 'ease-out' })
    return card
}
const updateCard = (card, agent) => {
    console.log('updateCard', agent)
    card.outerHTML = agentCard(agent)
}
const onSubmit = (e, id) => {
    console.log(e)
    ws.send(JSON.stringify({ id: id, message: e.target.querySelector('input').value }))
    e.target.remove()
    return false
}
const inputBox = (id, msg) => `<form onsubmit="return onSubmit(event, '${id}')">
                <label class="form-label">${msg}</label>
                <input type="text" class="form-control">
            </form>`

const new_websocket = (dispatch) => {
    const container = document.getElementById('main-content')
    const loader = document.getElementById('loader')
    const textMsg = document.getElementById('main-title')
    const ws = new WebSocket(`ws://${window.location.hostname}:${window.location.port}/ws`)
    ws.binaryType = "blob"
    ws.onopen = () => {
        textMsg.textContent = 'Connected'
        loader.remove()
    }
    ws.onclose = () => textMsg.textContent = 'Disconnected'
    ws.onerror = (e) => console.log(e)
    ws.onmessage = (m) => {
        try {
            if (typeof m.data == "string") {
                const data = JSON.parse(m.data)
                console.log(data)
                if (data.agents) {
                    for (const agent of data.agents) {
                        console.log(agent)
                        const card = document.getElementById(`agent-${agent.id}`)
                        if (card)
                            updateCard(card, agent)
                        else
                            container.prepend(addResult(container, agent))
                    }
                }
                if (data.state == 'request') {
                    let card = document.getElementById(`agent-${data.id}`)
                    if (!card) {
                        card = addResult(container, { id: data.id, messages: [] })
                        container.prepend(card)
                    }
                    textMsg.textContent = `Waiting for human input: ${data.id}`
                    const header = card.querySelector('.card-header')
                    header.innerHTML = `<h5 class="card-title">${data.id}</h5>${inputBox(data.id, data.message)}`
                        /*<div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>`*/
                } else if (data.state == 'running') {
                    //data.agents[data.agents.length - 1].messages.push(data.message)
                    loader.remove()
                    const lastAgent = data.agents[data.agents.length - 1]
                    textMsg.textContent = `Agent running: ${lastAgent.id}`
                    const card = document.getElementById(`agent-${lastAgent.id}`)
                    if (card) {
                        const header = card.querySelector('.card-header')
                        header.appendChild(loader)
                    }
                } else if (data.state == 'completed') {
                    textMsg.textContent = 'Completed'
                    loader.remove()
                }
            }
        } catch (e) {
            console.log(`Failed to handle websocket message:`)
            console.log(e)
        }
    }
    return ws
}
    </script>
</head>
<body class="bg-dark-subtle">
    <header>
        <div id="searchbar" class="container">
            <h1 id="main-title" class="display-5">Connecting...</h1>
            <div id="loader" class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            
        </div>
    </header>
    <div class="content" id="main-content"></div>
    <script>
const ws = new_websocket()
    </script>
</body>
</html>
